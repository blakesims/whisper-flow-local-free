# T026 Phase 7: KB Serve Frontend Fixes -- Implementation Plan

## Meta
- **Status:** READY
- **Created:** 2026-02-10
- **Last Updated:** 2026-02-10
- **Revision:** 2 (addresses plan-review.md issues: 2 critical, 3 major, 3 minor)

---

## Plan

### Objective
Fix four broken flows in the KB Serve carousel editor UI so that slides can be edited, saved, and re-rendered with any template -- enabling the full edit-preview-publish workflow from the browser. Additionally, add format switching via dropdown per Blake's decision (Question 2 = A).

### Scope
- **In:** Save Slides persistence bug, bullets/format display in editor, format switching dropdown, template switching + re-render, content editing for all formats (bullets, numbered, paragraph, mermaid read-only), subtitle editing for hook/CTA
- **Out:** Iteration view improvements (Phase 8), new analysis endpoints, Mermaid code editing (read-only is acceptable), drag-and-drop slide reordering, adding/removing slides

### Codebase Architecture Summary

**Backend endpoints (all in `/home/blake/repos/personal/whisper-transcribe-ui/kb/serve.py`):**
- `GET /api/action/<id>/slides` -- returns slide data from transcript JSON (line 685)
- `POST /api/action/<id>/save-slides` -- saves edited slides back to transcript JSON (line 742)
- `POST /api/action/<id>/render` -- re-renders carousel with specified template (line 846)
- `GET /api/templates` -- lists available templates from config.json (line 654)

**Frontend (single file):** `/home/blake/repos/personal/whisper-transcribe-ui/kb/templates/posting_queue.html`
- `buildSlideEditorHtml()` -- renders slide cards with title/content textareas (line 1881)
- `saveSlides()` -- collects edits from DOM and POSTs to save-slides endpoint (line 1799)
- `buildTemplateSelectorHtml()` -- template dropdown + re-render button (line 1935)
- `reRender()` -- POSTs to render endpoint with selected template (line 1847)

**Templates (3 active):** `/home/blake/repos/personal/whisper-transcribe-ui/kb/carousel_templates/`
- `brand-purple.html`, `modern-editorial.html`, `tech-minimal.html`
- All three use format-aware branching: `slide.bullets` array for bullets/numbered, `slide.content` string for paragraph/fallback

**Slide data schema** (from `carousel_slides.json` analysis type):
- Content slides: `{type: "content", title: str, bullets: [str, ...], format: "bullets"|"numbered"|"paragraph", content: str}`
- Hook slides: `{type: "hook", title: str, content: str (headline), subtitle: str}`
- CTA slides: `{type: "cta", title: str, content: str (question), subtitle: str}`
- Mermaid slides: `{type: "mermaid", title: str, content: str (mermaid code)}`

---

### Root Cause Analysis

#### Bug A: Save Slides Not Persisting

**Root cause:** The backend `save_slides` endpoint (line 794-807) only updates `title` and `content` fields on existing slides:
```python
if "title" in edited:
    existing["title"] = edited["title"]
if "content" in edited:
    existing["content"] = edited["content"]
```

The frontend `saveSlides()` function (line 1803-1816) collects data from DOM elements with classes `.slide-title-input` and `.slide-content-input`, sending `{slide_number, title, content}` objects.

**The problem is two-fold:**
1. The backend only writes `content`, but content slides now use `bullets` array (Phase 6 change). The backend must also write `bullets` (and `format`) back.
2. The frontend displays `slide.content` which is empty for bullet slides -- so the textarea is empty, the user sees nothing to edit, and even if they type something, the backend writes it to `content` which the template ignores in favor of `bullets`.

#### Bug B: Content Field Empty for Bullet Slides

**Root cause:** `buildSlideEditorHtml()` (line 1891) reads `slide.content || ''`. For content slides generated by the LLM after Phase 6, the data structure is `{bullets: ["item1", "item2", ...], format: "bullets"}` with no `content` field. The textarea shows empty.

**Fix:** The frontend must serialize `slide.bullets` into display text for the editor (e.g., one bullet per line), and parse edited text back into the `bullets` array on save.

#### Bug C: Template Switching + Re-render

**Root cause analysis:** The backend `render` endpoint (line 846) correctly accepts `{template: "name"}` from the request body and passes it to `render_pipeline()`. The frontend `reRender()` function (line 1847) sends `{template: templateName}`. The template selector `onchange` handler updates `selectedTemplate = this.value` (line 1950).

**The issue:** The Re-render button in the actions bar (line 1576) is gated by `canGenerate` which is computed as `(status === 'staged' || visualStatus === 'stale') && !isGenerating` (line 1535). If the item is in `ready` status with `visual_status === 'ready'`, the Re-render button is disabled because `canGenerate` evaluates false. This means after a successful first render, the user cannot re-render with a different template.

Additionally, `canGenerate` controls BOTH the "Generate Visuals" button (line 1572) AND the "Re-render" button (line 1576). But `generateVisuals()` has an internal guard `status !== 'staged'` (line 1664) -- if we simply expand `canGenerate` to include `ready`, the Generate Visuals button would appear clickable but silently do nothing. These two buttons need separate enable variables.

#### Bug D: Frontend Content Editing for All Formats

**Root cause:** The frontend has a single "Content" textarea per slide (line 1910-1912). It does not differentiate between `bullets`, `numbered`, `paragraph`, or `mermaid` content. Each format needs distinct handling:
- **bullets/numbered:** Display as one line per bullet. Parse back into `bullets` array on save.
- **paragraph:** Display as plain text in textarea. Save as `content` string.
- **mermaid:** Display as monospace code, read-only.
- **hook/cta:** Display `content` and `subtitle` fields.

---

### Phases

#### Phase 1: Data Serialization Layer (Frontend)
- **Objective:** Create functions to serialize slide data into editable text and parse edited text back into slide data structures. This is the foundation that fixes Bugs A, B, and D.

- **Tasks:**
  - [ ] Task 1.1: Add `slideToEditableText(slide)` function in posting_queue.html that converts:
    - bullets/numbered format: `slide.bullets.join('\n')` (one item per line)
    - paragraph format: `slide.content`
    - hook/cta: `slide.content`
    - mermaid: `slide.content`
    - backwards compat: if `slide.bullets` is missing but `slide.content` exists, fall back to `slide.content`
  - [ ] Task 1.2: Add `editableTextToSlideFields(text, slide, selectedFormat)` function that parses back:
    - bullets/numbered: split by newline, filter empty lines, return `{bullets: [...], format: selectedFormat, content: bullets.join('. ')}`
    - paragraph: return `{content: text, bullets: null, format: 'paragraph'}`
    - hook/cta: return `{content: text}`
    - mermaid: return `{content: text}` (pass-through unchanged -- mermaid textarea is readonly so text will be the original)
    - The `selectedFormat` parameter reads from the user's format dropdown choice, NOT from `slide.format` (handles format switching)
    - When `bullets` is returned, also set `content` to a joined fallback string (`bullets.join('. ')`) for backwards compatibility with any code reading `content` directly
  - [ ] Task 1.3: Add subtitle field handling for hook and CTA slides -- separate input for subtitle
  - [ ] Task 1.4: Add `convertContentForFormatChange(text, oldFormat, newFormat)` helper:
    - bullets/numbered to paragraph: join lines with `. ` (period-space) to form a single paragraph string
    - paragraph to bullets/numbered: split by `\n`, if only one line (no newlines), keep as single bullet (user can manually add line breaks to create more bullets)
    - bullets to numbered or numbered to bullets: no content change needed, just format field changes

- **Acceptance Criteria:**
  - [ ] AC1: `slideToEditableText()` round-trips cleanly: serialize -> display -> parse -> identical data
  - [ ] AC2: Empty lines and trailing whitespace are stripped during parse
  - [ ] AC3: Mermaid slide content passes through `editableTextToSlideFields()` unchanged
  - [ ] AC4: `convertContentForFormatChange()` correctly joins bullets into paragraph text and keeps single-line paragraphs as one bullet

- **Files:**
  - `/home/blake/repos/personal/whisper-transcribe-ui/kb/templates/posting_queue.html` -- add JS functions
- **Dependencies:** None

#### Phase 2: Slide Editor UI (Frontend)
- **Objective:** Update `buildSlideEditorHtml()` to use format-aware rendering, show all editable fields per slide type, and add format switching dropdown for content slides.

- **Tasks:**
  - [ ] Task 2.1: Update `buildSlideEditorHtml()` to call `slideToEditableText(slide)` instead of reading `slide.content || ''`
  - [ ] Task 2.2: Add a format `<select>` dropdown on each **content** slide card with options: `bullets`, `numbered`, `paragraph`. Pre-select the current `slide.format` value. Store the `data-slide-number` on the select for identification. Add an `onchange` handler that:
    - Reads the current textarea content
    - Calls `convertContentForFormatChange(text, oldFormat, newFormat)` to transform the text
    - Updates the textarea with the converted text
    - Tracks the slide as modified (enables Save Slides button)
  - [ ] Task 2.3: Add a subtitle textarea for hook and CTA slides (below the content textarea), with class `slide-subtitle-input`
  - [ ] Task 2.4: Show mermaid content as read-only monospace textarea (already partially done -- ensure content is populated via `slideToEditableText()`)
  - [ ] Task 2.5: Update `saveSlides()` to:
    - For each slide card, read the format dropdown value (if present, i.e., content slides) or infer the type from slide data
    - Call `editableTextToSlideFields(text, slide, selectedFormat)` to get structured data
    - Include `bullets`, `format`, `subtitle`, and `content` in the POST body (not just `title` and `content`)
    - **Exclude mermaid slides** from save collection entirely (mermaid textareas are readonly, so there is nothing to save; including them risks sending malformed data without a format field)

- **Acceptance Criteria:**
  - [ ] AC1: Bullet slides display their bullets as line-separated text in the textarea
  - [ ] AC2: Numbered slides display their bullets as line-separated text with "numbered" selected in format dropdown
  - [ ] AC3: Paragraph slides display their content string in the textarea with "paragraph" selected in format dropdown
  - [ ] AC4: Hook/CTA slides show both content and subtitle fields
  - [ ] AC5: Mermaid slides show their mermaid code in a read-only monospace textarea
  - [ ] AC6: Changing format dropdown from "bullets" to "paragraph" converts the textarea content (lines joined with `. `)
  - [ ] AC7: Changing format dropdown from "paragraph" to "bullets" keeps text as-is (split by newlines; single-line paragraph becomes one bullet)
  - [ ] AC8: Saving after a format change persists the new format to the backend
  - [ ] AC9: Mermaid slides are excluded from the save payload

- **Files:**
  - `/home/blake/repos/personal/whisper-transcribe-ui/kb/templates/posting_queue.html` -- update `buildSlideEditorHtml()` and `saveSlides()`
- **Dependencies:** Phase 1

#### Phase 3: Backend Save-Slides Fix
- **Objective:** Update the `save_slides` endpoint to handle `bullets`, `format`, and `subtitle` fields, not just `title` and `content`.

- **Tasks:**
  - [ ] Task 3.1: Update the save loop in `save_slides()` (serve.py lines 795-807) to also write `bullets`, `format`, and `subtitle` from the edited data
  - [ ] Task 3.2: When `bullets` is present and non-empty, set `content` to a joined fallback string (`'. '.join(bullets)`) and write `bullets` array. When `format` is `paragraph`, clear `bullets` (set to `None` or remove key) and write `content`.
  - [ ] Task 3.3: Validate incoming data: `bullets` must be a list of strings (if present), `format` must be one of `["bullets", "numbered", "paragraph"]` (if present), `subtitle` must be a string (if present). Return 400 for invalid values.

- **Acceptance Criteria:**
  - [ ] AC1: Editing a bullet slide's bullets and clicking Save persists the changes to the transcript JSON (both `bullets` array and `content` fallback string)
  - [ ] AC2: Editing a paragraph slide's content and clicking Save persists the change (and clears `bullets` if previously present)
  - [ ] AC3: Subtitle edits on hook/CTA slides persist
  - [ ] AC4: Re-rendering after save uses the updated data
  - [ ] AC5: Sending `format: "invalid"` returns 400 error

- **Files:**
  - `/home/blake/repos/personal/whisper-transcribe-ui/kb/serve.py` -- update `save_slides()` endpoint (lines 742-843)
- **Dependencies:** Phase 2 (frontend sends the new fields)

#### Phase 4: Template Switching + Button Enable Fix
- **Objective:** Fix the Re-render button so it works when the item is already in `ready` state, and split the enable logic so Generate Visuals and Re-render have independent conditions.

- **Tasks:**
  - [ ] Task 4.1: Split `canGenerate` (line 1535) into two separate variables:
    - `canGenerate` = `status === 'staged' && !isGenerating` -- Generate Visuals only works for staged items (matches the `generateVisuals()` internal guard at line 1664)
    - `canReRender` = `(status === 'staged' || status === 'ready' || visualStatus === 'stale') && !isGenerating` -- Re-render works for staged, ready, or stale items
  - [ ] Task 4.2: Update the button HTML (lines 1572-1578):
    - Generate Visuals button: use `canGenerate` for its disabled attribute
    - Re-render button in actions bar: use `canReRender` for its disabled attribute
  - [ ] Task 4.3: The template selector Re-render button (line 1953) has no separate disable logic -- it is always rendered if the template selector is visible. Confirm it calls `reRender()` which has its own internal guard (line 1849-1850: `status !== 'staged' && status !== 'ready'`). This is correct and needs no change.
  - [ ] Task 4.4: After a re-render completes, refresh the thumbnail preview in the visual status area (existing behavior via `pollVisualGeneration` -- verify it works)

- **Acceptance Criteria:**
  - [ ] AC1: When an item is in "ready" status, the Re-render button is enabled but Generate Visuals is disabled
  - [ ] AC2: When an item is in "staged" status, both buttons are enabled
  - [ ] AC3: Selecting a different template and clicking Re-render starts a render with the new template
  - [ ] AC4: After render completes, the thumbnail updates to show the new template's output
  - [ ] AC5: Template-only switch (no save, just pick new template and re-render) works correctly: re-render does NOT require a save first, and the item transitions back to `ready` status after render completes (confirmed: render endpoint line 929 sets `status = "ready"`)

- **Files:**
  - `/home/blake/repos/personal/whisper-transcribe-ui/kb/templates/posting_queue.html` -- split `canGenerate` variable and update button attributes
- **Dependencies:** None (can be done in parallel with Phases 1-3)

#### Phase 5: Integration Testing
- **Objective:** Verify the full round-trip workflow: load slides -> display -> edit -> save -> re-render -> verify output.

- **Tasks:**
  - [ ] Task 5.1: Manual end-to-end test with a real carousel item: edit bullet slide content, save, re-render, verify PDF reflects changes
  - [ ] Task 5.2: Test template switching: render with brand-purple, switch to tech-minimal, re-render, verify output uses new template
  - [ ] Task 5.3: Test template-only switch (no content edits): from `ready` status, change template dropdown, click Re-render directly WITHOUT saving first. Verify render succeeds and item returns to `ready` status (no status downgrade to `staged`)
  - [ ] Task 5.4: Test all slide types: edit hook title/subtitle, edit content bullets, edit paragraph content, verify mermaid is read-only and excluded from save
  - [ ] Task 5.5: Test format switching: change a bullet slide to paragraph format, verify textarea content converts. Change it back to bullets, verify it splits by newline. Save and re-render to confirm the format change persists and renders correctly.
  - [ ] Task 5.6: Test edge cases: empty bullets (should be stripped), very long content, slides with only `content` (backwards compat, no `bullets` array), single-line paragraph converted to bullets (becomes one bullet)
  - [ ] Task 5.7: Test button states: verify Generate Visuals is disabled for `ready` items but Re-render is enabled. Verify both are disabled during `generating` status.

- **Acceptance Criteria:**
  - [ ] AC1: Full save -> re-render round-trip works for bullet, numbered, and paragraph slides
  - [ ] AC2: Template switching produces correct output
  - [ ] AC3: Template-only re-render (without prior save) works from `ready` status
  - [ ] AC4: Format switching + save + re-render works end-to-end
  - [ ] AC5: No regressions in existing iteration/staging workflow

- **Files:** None (manual testing)
- **Dependencies:** Phases 1-4

---

### Decision Matrix

#### Open Questions (Resolved by Blake)
| # | Question | Options | Impact | Resolution |
|---|----------|---------|--------|------------|
| 1 | Subtitle editing for hook/CTA slides | A) Add separate subtitle textarea below content B) Keep subtitle hidden (not editable from UI) | If B, subtitles can only be changed by re-running the LLM. A gives full control. | **A -- editable** |
| 2 | Format switching in editor | A) Allow changing a slide's format (e.g., bullets -> numbered) via a dropdown B) Keep format read-only (set by LLM, user edits content only) | A is more powerful but adds complexity. B is simpler and the format is already chosen well by the LLM. | **A -- format dropdown** |
| 3 | Mermaid code editing | A) Keep mermaid content read-only (current behavior) B) Make mermaid editable (advanced users could tweak diagram code) | B is risky -- broken mermaid code would fail render. A is safer. | **A -- read-only (mermaid->SVG refactor deferred to T027)** |

#### Decisions Made (Autonomous)
| Decision | Choice | Rationale |
|----------|--------|-----------|
| Bullet display format in editor | One bullet per line, no prefix characters | Simplest to type and parse; matches how users naturally enter lists |
| Backend save: clear stale fields | When saving bullets, also set `content` to joined fallback. When saving paragraph, clear `bullets`. | Prevents template confusion about which field to render; backwards compat for code reading `content` |
| Template selector placement | Keep existing position (above post editor area) | Already implemented and positioned well |
| Mermaid in save flow | Exclude mermaid slides from save collection | Mermaid textarea is readonly, no edits to persist. Including would risk malformed data with no format field. |
| Paragraph-to-bullets conversion | Split by newline; single-line paragraph becomes one bullet | Keep it simple. User can manually add newlines to create more bullets before switching format. Sentence-splitting is fragile and surprising. |
| canGenerate split | Separate `canGenerate` (staged only) and `canReRender` (staged/ready/stale) | `generateVisuals()` has internal guard rejecting non-staged. Shared variable would create misleading UX with a clickable but non-functional button. |
| `content` fallback on bullet save | Set `content = bullets.join('. ')` when saving bullets | Templates fall back to `slide.content` via `markdown_to_html` when `slide.bullets` is absent (brand-purple line 418-419). A populated `content` field ensures graceful degradation. |

---

### Risk Assessment
- **Low risk:** All changes are in two files (`serve.py` and `posting_queue.html`). No schema changes, no LLM prompt changes, no template changes.
- **Backwards compatibility:** Slides without `bullets` array (old format) still work -- `slideToEditableText()` falls back to `slide.content`.
- **Data integrity:** The save endpoint must be careful not to lose fields. The fix writes all fields from the edit, preserving `type` and `slide_number` as read-only.
- **Format switching edge case:** Paragraph with no newlines becomes a single bullet. This is documented behavior and the simplest correct approach -- user controls bullet separation via line breaks.
