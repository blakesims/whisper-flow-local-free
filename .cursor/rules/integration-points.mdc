---
description: Key integration points with external services, libraries, and APIs.
globs:
alwaysApply: false
---

# Integration Points and External Services

## 1. Gemini API (google-genai SDK)

-   **Library**: `google-genai` v1.17.0 (NOT the deprecated `google-generativeai`)
-   **Usage**: `kb/analyze.py` — all LLM analysis (linkedin_v2, carousel_slides, judge, etc.)
-   **Auth**: `GEMINI_API_KEY` environment variable
-   **Model**: `gemini-3-pro-preview` (default, never use Flash for content generation)
-   **Structured Output**:
    -   Use `response_schema` (raw dict or Pydantic). `response_json_schema` does NOT exist in v1.17.0.
    -   `minLength`/`maxLength`/`pattern` are silently ignored. Only `enum` and `format` are enforced.
    -   For bullet-point content, use `type: array` + `items: {type: string}` — don't ask the model to format strings with `- ` prefixes.
-   **Config**: Analysis type configs in `kb/config/analysis_types/*.json`. Runtime loads from `KB_ROOT/config/`, not repo.

## 2. Carousel Rendering Pipeline

-   **Jinja2**: HTML template rendering (`kb/render.py`)
    -   Templates in `kb/carousel_templates/` (brand-purple, modern-editorial, tech-minimal)
    -   Config: `kb/carousel_templates/config.json` (fonts, colors, dimensions, brand settings)
-   **Playwright**: HTML → PDF conversion (`kb/render.py::render_html_to_pdf`)
    -   Also generates per-slide PNG thumbnails
-   **Mermaid (mmdc)**: Diagram rendering for mermaid-type slides (`kb/render.py::render_mermaid`)
    -   Prompt instructs LLM to include `%%{init}` theming directive with brand colors

## 3. Flask Web Dashboard (kb serve)

-   **Library**: Flask
-   **Port**: 8765 (default)
-   **Routes**: Action queue (`/`), browse mode (`/browse`), API endpoints (`/api/...`)
-   **State**: `~/.kb/action-state.json`, `~/.kb/video-inventory.json`
-   **Deployment**: systemd service on server (zen), scripts in `deploy/`

## 4. Whisper Transcription

-   **whisper.cpp** (primary, daemon mode): via `pywhispercpp` — `app/core/transcription_service_cpp.py`
-   **faster-whisper** (legacy, full UI): — `app/core/transcription_service.py`
-   **Unified import**: `kb/transcription.py` provides `get_transcription_service`

## 5. Configuration Management

-   **App config**: `app/utils/config_manager.ConfigManager` — `settings.json` in OS app support dir
-   **KB config**: `kb/config.py` — `KB_ROOT` points to `~/Obsidian/zen-ai/knowledge-base/transcripts/`
-   **Carousel config**: `kb/carousel_templates/config.json` — template settings, fonts, colors, brand

## 6. Audio & Clipboard

-   **sounddevice**: Microphone recording (`app/core/audio_recorder.py`)
-   **ffmpeg**: Audio extraction from video files (network volumes, `transcribe_file.py`)
-   **pyperclip**: Clipboard copy after transcription

## 7. Fabric Pattern Processing

-   **Mechanism**: Pipes text to `fabric` CLI via subprocess
-   **Usage**: Full UI mode only (secondary)
